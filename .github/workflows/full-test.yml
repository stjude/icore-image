name: Full Test

on:
  workflow_dispatch:

jobs:
  full-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install JRE8 for Linux
        run: |
          curl -s "https://api.adoptium.net/v3/assets/feature_releases/8/ga?os=linux&architecture=x64&image_type=jre&jvm_impl=hotspot" \
          | jq -r '.[] | .binaries[] | select(.image_type=="jre") | .package.link' \
          | head -n1 \
          | xargs curl -L \
          | tar -xz
          mv jdk8*-jre jre8
      
      - name: Install DCMTK for Linux
        run: |
          curl -L https://dcmtk.org/download/dcmtk/dcmtk369/bin/dcmtk-3.6.9-linux-debian-11-x86_64-static.tar.bz2 | tar -xj
          mv dcmtk-3.6.9-linux-debian-11-x86_64-static dcmtk
          cd dcmtk/bin && find . -type f ! -name 'findscu' ! -name 'movescu' -delete
      
      - name: Verify Docker is working
        run: |
          docker version
          docker info
          docker ps
      
      - name: Install dependencies
        run: make deps
      
      - name: Run tests
        run: make test

