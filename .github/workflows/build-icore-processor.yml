name: Build iCore Processor

on:
  push:
    branches:
      - build-icore-processor

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: macos-intel
            runs-on: macos-15-intel
            jre-arch: x64
            dcmtk-url: https://dicom.offis.de/download/dcmtk/dcmtk369/bin/dcmtk-3.6.9-macosx-x86_64.tar.bz2
            artifact-name: icore_processor-macos-intel
          - platform: ubuntu
            runs-on: ubuntu-latest
            jre-arch: x64
            dcmtk-url: https://dicom.offis.de/download/dcmtk/dcmtk369/bin/dcmtk-3.6.9-linux-x86_64.tar.bz2
            artifact-name: icore_processor-ubuntu

    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Download spacy model
        run: python -m spacy download en_core_web_sm

      - name: Download and setup JRE 8
        run: |
          if [ "${{ matrix.platform }}" = "ubuntu" ]; then
            curl -s "https://api.adoptium.net/v3/assets/feature_releases/8/ga?os=linux&architecture=${{ matrix.jre-arch }}&image_type=jre&jvm_impl=hotspot" \
            | jq -r '.[] | .binaries[] | select(.image_type=="jre") | .package.link' \
            | head -n1 \
            | xargs curl -L \
            | tar -xz
            mv jdk8*-jre jre8
          else
            curl -s "https://api.adoptium.net/v3/assets/feature_releases/8/ga?os=mac&architecture=${{ matrix.jre-arch }}&image_type=jre&jvm_impl=hotspot" \
            | jq -r '.[] | .binaries[] | select(.image_type=="jre") | .package.link' \
            | head -n1 \
            | xargs curl -L \
            | tar -xj
            mv jdk8*-jre jre8
          fi

      - name: Download and setup dcmtk
        run: |
          curl -L ${{ matrix.dcmtk-url }} | tar -xj
          if [ "${{ matrix.platform }}" = "ubuntu" ]; then
            mv dcmtk-3.6.9-linux-x86_64 dcmtk
          else
            mv dcmtk-3.6.9-macosx-x86_64 dcmtk
          fi
          cd dcmtk/bin
          find . -type f ! -name 'findscu' ! -name 'movescu' -delete
          cd ../..

      - name: Build with PyInstaller
        run: |
          rm -rf dist
          pyinstaller --clean -y icore_processor.spec

      - name: Create gzipped archive
        run: |
          tar -czf ${{ matrix.artifact-name }}.tar.gz -C dist icore_processor

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-name }}.tar.gz
