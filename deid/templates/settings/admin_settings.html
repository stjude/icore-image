{% extends 'settings/base_settings.html' %}

{% block title %}Administrator Settings{% endblock %}

{% block settings_content %}
<div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center" style="z-index: 1000;">
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-lg mb-4">Enter Administrator Password</h2>
        <input type="password" 
               id="admin-password" 
               class="border-2 border-gray-300 p-2 mb-4 w-full"
               placeholder="Enter password">
        <div class="flex justify-end space-x-2">
            <button onclick="verifyPassword()" 
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                Submit
            </button>
        </div>
        <div id="password-error" class="text-red-500 mt-2 hidden">
            Incorrect password
        </div>
    </div>
</div>

<div id="settings-content" class="hidden">
    <meta name="csrf_token" content="{{ csrf_token }}">
    <div class="mt-6">
        <div class="text-md mb-4">Protocol Configuration</div>
        <div class="grid grid-cols-1 gap-4">
            <div>
                <div class="text-sm text-gray-500 mb-2">Current Protocol File</div>
                <div class="flex items-center space-x-4">
                    <input type="text" 
                        class="flex-1 border-2 border-gray-400 p-1" 
                        id="protocol_display"
                        readonly>
                    <input type="file" 
                        id="protocol_file" 
                        class="hidden" 
                        accept=".xlsx,.xls">
                    <button onclick="document.getElementById('protocol_file').click()" 
                            class="px-4 py-1 bg-white shadow text-sm hover:bg-blue-100">
                        Upload New
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8">
        <div class="text-md mb-4">Site Data Configuration</div>
        <div class="grid grid-cols-2 gap-8">
            <div>
                <div class="text-sm text-gray-500 mb-2">Date Shift Range (days)</div>
                <input type="number" 
                    class="w-full border-2 border-gray-400 p-1" 
                    id="date_shift_range" 
                    min="0"
                    value="-3210">
                <div class="text-xs text-gray-400 mt-1">Number of days to shift dates</div>
            </div>
            <div>
                <div class="text-sm text-gray-500 mb-2">Site ID</div>
                <input type="text" 
                    class="w-full border-2 border-gray-400 p-1" 
                    id="site_id" 
                    placeholder="Enter site ID">
            </div>
        </div>
        <div class="mt-8">
            <div class="text-md mb-4">Azure Storage SAS URL</div>
            <div class="text-sm text-gray-500 mb-2">SAS URL for Secure Data Transfer</div>
            <div class="flex gap-2">
                <input type="text" 
                    class="flex-1 border-2 border-gray-400 p-1" 
                    id="imagine_sas_url" 
                    placeholder="https://account.blob.core.windows.net/container?sas_token">
                <button type="button" 
                        onclick="validateSasUrlInAdmin()" 
                        id="validateSasBtnAdmin"
                        class="px-4 py-1 bg-white shadow text-sm rounded hover:bg-blue-100">
                    Validate
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Azure Blob Storage SAS URL for secure data transfer</p>
            <div id="sasValidationResultAdmin" class="mt-2 p-2 text-sm hidden"></div>
        </div>
    </div>

{% endblock %}

{% block settings_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    setupEventListeners();
    document.getElementById('password-modal').style.display = 'flex';
    document.getElementById('settings-content').classList.add('hidden');
});

async function verifyPassword() {
    const password = document.getElementById('admin-password').value;
    const errorDiv = document.getElementById('password-error');
    
    try {
        const response = await fetch('/verify_admin_password/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').content
            },
            body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (data.valid) {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('settings-content').classList.remove('hidden');
            loadSettings();
            setupEventListeners();
        } else {
            errorDiv.classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        }
    } catch (error) {
        console.error('Error verifying password:', error);
        errorDiv.classList.remove('hidden');
    }
}

// Add event listener for Enter key
document.getElementById('admin-password').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        verifyPassword();
    }
});

function setupEventListeners() {
    // Update displayed filename when a new file is selected
    document.getElementById('protocol_file').addEventListener('change', function(e) {
        if (this.files[0]) {
            document.getElementById('protocol_display').value = this.files[0].name;
        }
    });

    // Add save button listener
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
}

async function loadSettings() {
    try {
        const response = await fetch('/load_admin_settings/');
        if (!response.ok) throw new Error('Failed to load settings');
        
        const settings = await response.json();
        
        if (settings.protocol_file) {
            document.getElementById('protocol_display').value = settings.protocol_file ? settings.protocol_file.split('/').pop() : '';
        }
        if (settings.date_shift_range) {
            document.getElementById('date_shift_range').value = settings.date_shift_range;
        }
        if (settings.site_id) {
            document.getElementById('site_id').value = settings.site_id;
        }
        if (settings.imagine_sas_url) {
            document.getElementById('imagine_sas_url').value = settings.imagine_sas_url;
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

async function saveSettings() {
    try {
        const formData = new FormData();
        const protocolFile = document.getElementById('protocol_file').files[0];
        const dateShiftRange = document.getElementById('date_shift_range').value;
        const siteId = document.getElementById('site_id').value;
        const imagineSasUrl = document.getElementById('imagine_sas_url').value;

        if (protocolFile) {
            formData.append('protocol_file', protocolFile);
        }
        if (dateShiftRange) {
            formData.append('default_date_shift_days', dateShiftRange);
        }
        if (siteId) {
            formData.append('site_id', siteId);
        }
        if (imagineSasUrl) {
            formData.append('imagine_sas_url', imagineSasUrl);
        }
        const response = await fetch('/save_admin_settings/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrf_token]').content
            },
            body: formData
        });

        if (!response.ok) throw new Error('Failed to save settings');
        
        showSaveMessage('Settings saved successfully');
    } catch (error) {
        console.error('Error saving settings:', error);
        showSaveMessage('Error saving settings', true);
    }
}

function showSaveMessage(message, isError = false) {
    const saveButton = document.getElementById('saveSettingsBtn');
    const existingMessage = document.querySelector('.settings-message');
    if (existingMessage) existingMessage.remove();

    const messageDiv = document.createElement('div');
    messageDiv.textContent = message;
    messageDiv.className = `settings-message mt-4 ml-4 ${isError ? 'text-red-500' : 'text-green-500'}`;
    saveButton.parentNode.appendChild(messageDiv);

    setTimeout(() => messageDiv.remove(), 3000);
}

async function validateSasUrlInAdmin() {
    const sasUrl = document.getElementById('imagine_sas_url').value.trim();
    const resultDiv = document.getElementById('sasValidationResultAdmin');
    const validateBtn = document.getElementById('validateSasBtnAdmin');
    
    if (!sasUrl) {
        resultDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
        resultDiv.classList.add('bg-red-100', 'text-red-700');
        resultDiv.textContent = 'Please enter a SAS URL';
        resultDiv.classList.remove('hidden');
        return;
    }
    
    validateBtn.disabled = true;
    validateBtn.textContent = 'Validating...';
    resultDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
    resultDiv.classList.add('bg-blue-100', 'text-blue-700');
    resultDiv.textContent = 'Validating SAS URL...';
    resultDiv.classList.remove('hidden');
    
    try {
        const response = await fetch('/validate_sas_url/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').content
            },
            body: JSON.stringify({ sas_url: sasUrl })
        });
        
        const result = await response.json();
        
        if (result.valid) {
            resultDiv.classList.remove('bg-blue-100', 'text-blue-700');
            resultDiv.classList.add('bg-green-100', 'text-green-700');
            resultDiv.textContent = 'SAS URL is valid! Remember to click "Save Settings" to save it.';
        } else {
            resultDiv.classList.remove('bg-blue-100', 'text-blue-700');
            resultDiv.classList.add('bg-red-100', 'text-red-700');
            resultDiv.textContent = `Validation failed: ${result.error}`;
        }
    } catch (error) {
        resultDiv.classList.remove('bg-blue-100', 'text-blue-700');
        resultDiv.classList.add('bg-red-100', 'text-red-700');
        resultDiv.textContent = `Error: ${error.message}`;
    } finally {
        validateBtn.disabled = false;
        validateBtn.textContent = 'Validate';
    }
}
</script>
{% endblock %} 