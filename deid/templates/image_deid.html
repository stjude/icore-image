{% extends 'base.html' %}

{% block title %}Image Deidentification{% endblock %}

{% block content %}
{{ protocols|json_script:"protocols-data" }}
<script>
    const protocols = JSON.parse(document.getElementById('protocols-data').textContent);
</script>
<div class="px-4">
    <h1 class="text-xl flex-1">Image Deidentification</h1>
</div>
<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <div class="text-sm text-black-5">Project Name</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="study_name" onkeypress="return event.charCode !== 32"/>
    <!-- <div class="text-sm text-black-5 mt-4">Protocol</div>
    <div class="flex items-center space-x-4">
        <select id="protocol_select" 
                class="bg-white mt-2 w-full border-2 border-gray-400 p-2" 
                onchange="handleProtocolChange()">
            <option value="">Select a protocol...</option>
            {% for protocol in protocols %}
                <option value="{{ protocol }}">{{ protocol }}</option>
            {% endfor %}
        </select>
        <span id="restricted-label" class="text-red-500 font-medium hidden">Restricted Protocol</span>
    </div> -->
    <div class="text-sm mt-6 text-black flex items-center space-x-4">
        Image Source: 
        <input class="ml-4" type="radio" id="image_source_local" name="image_source" value="LOCAL" checked onchange="toggleSourceOptions()"><span>Local folder</span>
        <input class="ml-4" type="radio" id="image_source_pacs" name="image_source" value="PACS" onchange="toggleSourceOptions()"> <span>PACS</span>
    </div>
    <div id="pacs_options" class="hidden mt-4">
        <div class="text-sm text-gray-500">Input File</div>
        <div class="flex items-center">
            <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_file" placeholder="Drag and drop query excel file" />
        </div>
        <div class="flex items-center mt-4">
            <div class="text-sm text-gray-600">Query using:</div>
            <input class="ml-4" type="radio" id="query_accession" name="query_type" value="accession" checked onchange="toggleQueryTypeInputs()"><span class="text-sm ml-1">Accession</span>
            <input class="ml-4" type="radio" id="query_mrn_date" name="query_type" value="mrn_date" onchange="toggleQueryTypeInputs()"><span class="text-sm ml-1">MRN + Date</span>
        </div>
        
        <!-- Hidden inputs to store actual values -->
        <input type="hidden" name="accession_column" id="accession_column_value" />
        <input type="hidden" name="mrn_column" id="mrn_column_value" />
        <input type="hidden" name="date_column" id="date_column_value" />
        
        <div id="accession_display" class="mt-2">
            <div class="text-sm text-gray-500">
                Accession column: <span id="accession_column_display">AccessionNumber</span> 
                <a href="#" onclick="openColumnModal('accession'); return false;" class="text-blue-600 hover:text-blue-800 ml-2">(Change)</a>
            </div>
        </div>
        
        <div id="mrn_date_display" class="hidden mt-2">
            <div class="text-sm text-gray-500">
                MRN column: <span id="mrn_column_display">PatientID</span> 
                <a href="#" onclick="openColumnModal('mrn'); return false;" class="text-blue-600 hover:text-blue-800 ml-2">(Change)</a>
                <span class="ml-6">Date column: <span id="date_column_display">StudyDate</span></span>
                <a href="#" onclick="openColumnModal('date'); return false;" class="text-blue-600 hover:text-blue-800 ml-2">(Change)</a>
            </div>
        </div>
    </div>
    <div id="local_folder_options">
        <div id="input_folder_container">
            <div class="text-sm text-gray-500 mt-4">Input Folder</div>
            <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_folder" placeholder="Drag and drop folder images folder" />
        </div>
    </div>
    <div class="text-sm text-gray-500 mt-4">Output Folder</div>
    <input type="text" class="mt-2 mb-2 w-full h-full border-2 border-gray-400 p-2" name="output_folder" />
    <div class="flex items-center mt-4">
        <button class="text-black" onclick="toggleDeidOptions()" id="deidOptionsButton">▼</button>
        <div class="text-sm text-black ml-4">Deidentification Options</div>
    </div>
    <div id="deid_options" class="mt-4 hidden ml-4">
        <!-- General Filters Section -->
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">General Filters</div>
            <div class="text-sm text-gray-400 mb-2">Only include images where</div>
            {% include 'components/add_filters.html' %}
        </div>

        <!-- Modality Filters Section -->
        <div class="mt-4">
            <div class="flex items-center">
                <input type="checkbox" 
                       id="modality-filter-toggle" 
                       class="mr-2"
                       onchange="toggleModalityFilters()">
                <label for="modality-filter-toggle">Filter by Modality</label>
            </div>

            <!-- Modality options -->
            <div id="modality-options" class="ml-4 mt-2 hidden">
                <div class="grid grid-cols-1 gap-2">
                    {% for modality in modalities %}
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="modality-{{ modality }}" 
                                   value="{{ modality }}"
                                   class="modality-checkbox mr-2"
                                   onchange="handleModalitySelection(this)">
                            <label for="modality-{{ modality }}">{{ modality }}</label>
                        </div>
                        <div id="filters-{{ modality }}" class="ml-4 mt-2 hidden"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Container for modality-specific filters -->
            <div id="modality-filters-container" class="ml-4 mt-2">
            </div>
        
        </div>
        
        <!-- Advanced Deidentification Options Section -->
        <div class="mt-6">
            <div class="text-md mb-2">Advanced Deidentification Options</div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <div class="text-sm text-gray-500">To keep</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="tags_to_keep"></textarea>
                </div>
                <div class="flex-1">
                    <div class="text-sm text-gray-500">To date shift</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="tags_to_dateshift"></textarea>
                </div>
                <div class="flex-1">
                    <div class="text-sm text-gray-500">To randomize</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="tags_to_randomize"></textarea>
                </div>
            </div>
        </div>
        <div class="mt-8">
            <div class="text-md mb-4">Global Deidentification Settings</div>
            <div class="space-y-4">
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" id="remove_unspecified" name="remove_unspecified" class="mr-2">
                        <label for="remove_unspecified">Remove unspecified tags</label>
                    </div>
                    <div class="text-sm text-gray-500 ml-6">If checked, any tag not specified in the lists above will be removed. If unchecked, unspecified tags will be preserved</div>
                </div>
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" id="remove_overlays" name="remove_overlays" class="mr-2">
                        <label for="remove_overlays">Remove overlays</label>
                    </div>
                    <div class="text-sm text-gray-500 ml-6">Remove all elements in 60xx groups. These are overlays and are sometimes removed when fully de-identifying an object because they can contain PHI.</div>
                </div>
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" id="remove_curves" name="remove_curves" class="mr-2">
                        <label for="remove_curves">Remove curve data</label>
                    </div>
                    <div class="text-sm text-gray-500 ml-6">Remove all elements in 50xx groups. These are groups which contain curve data.</div>
                </div>
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" id="remove_private" name="remove_private" class="mr-2">
                        <label for="remove_private">Remove all private tags</label>
                    </div>
                    <div class="text-sm text-gray-500 ml-6">Remove all elements in odd-numbered groups. These are private groups whose contents are not specified by the DICOM standard</div>
                </div>
            </div>
        </div>
        <div class="mt-8">
            <div class="text-md mb-4">Pixel Deidentification</div>
            <div class="mb-4">
                <div class="flex items-center">
                    <input type="checkbox" id="deid_pixels" name="deid_pixels" class="mr-2">
                    <label for="deid_pixels">Deidentify pixel data from known scanners</label>
                </div>
                <div class="text-sm text-gray-500 ml-6">Blanks regions of pixels in a DICOM image from known scanners.</div>
            </div>
            <div class="text-md mb-4 mt-8">Lookup Table Configuration</div>
            <div>
                <div class="flex items-center">
                    <input type="checkbox" id="use_lookup" name="use_lookup" class="mr-2" onchange="toggleLookupInput()">
                    <label for="use_lookup">Use Lookup Table</label>
                </div>
                <div id="lookup_input_container" class="mt-2 hidden">
                    <input type="text" class="w-full h-full border-2 border-gray-400 p-2" name="lookup_file" />
                    <div class="text-sm text-gray-500 mt-1">Excel file containing lookup table for PHI replacement</div>
                </div>
            </div>
        </div>    
    </div>
</div>
<div class="m-4">
    <div class="flex items-center mb-4">
        <input type="checkbox" id="schedule_job" class="mr-2" onchange="toggleScheduling()">
        <label for="schedule_job">Schedule Job</label>
    </div>
    
    <div id="scheduling_options" class="hidden mb-4">
        <input type="datetime-local" id="scheduled_time" class="border-2 border-gray-400 p-2">
    </div>

    <button class="mt-4 mb-4 px-2 py-1 bg-white shadow text-sm hover:bg-blue-100" onclick="runDeid()" id="deid_button">
        Deidentify
    </button>
</div>

<!-- Column Name Modal -->
<div id="column-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden" style="z-index: 1000;">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h3 class="text-lg font-medium mb-4" id="modal-title">Edit Column Name</h3>
        <div class="mb-4">
            <label class="text-sm text-gray-600 mb-2 block" id="modal-label">Column Name:</label>
            <input type="text" id="modal-input" class="w-full border-2 border-gray-400 p-2" />
        </div>
        <div class="flex justify-end gap-2">
            <button onclick="closeColumnModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                Cancel
            </button>
            <button onclick="saveColumnValue()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                Save
            </button>
        </div>
    </div>
</div>

<script>
    let settings = {};
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/load_settings/');
            settings = await response.json();
            
            // Apply default settings
            if (settings.default_image_source) {
                document.querySelector(`input[name="image_source"][value="${settings.default_image_source}"]`).checked = true;
                toggleSourceOptions();
            }
            if (settings.default_query_method === "Accession") {
                document.getElementById('query_accession').checked = true;
            } else {
                document.getElementById('query_mrn_date').checked = true;
            }
            toggleQueryTypeInputs(); // Update display based on selected query method
            if (settings.default_accession_header) {
                setColumnValue('accession', settings.default_accession_header);
            } else {
                setColumnValue('accession', 'AccessionNumber');
            }
            if (settings.default_mrn_header) {
                setColumnValue('mrn', settings.default_mrn_header);
            } else {
                setColumnValue('mrn', 'PatientID');
            }
            if (settings.default_date_header) {
                setColumnValue('date', settings.default_date_header);
            } else {
                setColumnValue('date', 'StudyDate');
            }
            if (settings.default_output_folder) {
                document.querySelector('[name="output_folder"]').value = settings.default_output_folder;
            }

            if (settings.selected_protocol) {
                document.getElementById('protocol_select').value = settings.selected_protocol;
                handleProtocolChange();
            }
            if (settings.default_tags_to_keep) {
                document.querySelector('[name="tags_to_keep"]').value = settings.default_tags_to_keep;
            }
            if (settings.default_tags_to_dateshift) {
                document.querySelector('[name="tags_to_dateshift"]').value = settings.default_tags_to_dateshift;
            }
            if (settings.default_tags_to_randomize) {
                document.querySelector('[name="tags_to_randomize"]').value = settings.default_tags_to_randomize;
            }
            if (settings.lookup_file) {
                document.querySelector('[name="lookup_file"]').value = settings.lookup_file;
            }
            if (settings.use_lookup) {
                document.getElementById('use_lookup').checked = settings.use_lookup;
                toggleLookupInput();
            }
            if (settings.default_deid_pixels) {
                document.getElementById('deid_pixels').checked = settings.default_deid_pixels;
            }
            if (settings.default_remove_unspecified !== undefined) {
                document.getElementById('remove_unspecified').checked = settings.default_remove_unspecified;
            }
            if (settings.default_remove_overlays !== undefined) {
                document.getElementById('remove_overlays').checked = settings.default_remove_overlays;
            }
            if (settings.default_remove_curves !== undefined) {
                document.getElementById('remove_curves').checked = settings.default_remove_curves;
            }
            if (settings.default_remove_private !== undefined) {
                document.getElementById('remove_private').checked = settings.default_remove_private;
            }
            if (settings.deid_filters) {
                loadFiltersFromSettings(settings.deid_filters);
            }

            // Get timezone and send to server
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            fetch('/set_timezone/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ timezone: timezone })
            });

        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });

    function toggleSourceOptions() {
        const pacsOptions = document.getElementById('pacs_options');
        const imageSourcePacs = document.getElementById('image_source_pacs')
        const inputFolderContainer = document.getElementById('input_folder_container')
        if (imageSourcePacs.checked){
            pacsOptions.classList.remove('hidden');
            inputFolderContainer.classList.add('hidden');
        } else{
            pacsOptions.classList.add('hidden');
            inputFolderContainer.classList.remove('hidden');
        }
        updateButtonText();
    }
    
    let currentEditColumn = '';

    function toggleQueryTypeInputs() {
        const accessionDisplay = document.getElementById('accession_display');
        const mrnDateDisplay = document.getElementById('mrn_date_display');
        const queryAccession = document.getElementById('query_accession');
        
        if (queryAccession.checked) {
            accessionDisplay.classList.remove('hidden');
            mrnDateDisplay.classList.add('hidden');
        } else {
            accessionDisplay.classList.add('hidden');
            mrnDateDisplay.classList.remove('hidden');
        }
    }

    function openColumnModal(columnType) {
        currentEditColumn = columnType;
        const modal = document.getElementById('column-modal');
        const modalInput = document.getElementById('modal-input');
        const modalTitle = document.getElementById('modal-title');
        const modalLabel = document.getElementById('modal-label');
        
        let currentValue = '';
        if (columnType === 'accession') {
            modalTitle.textContent = 'Edit Accession Column Name';
            modalLabel.textContent = 'Accession Column Name:';
            currentValue = document.getElementById('accession_column_display').textContent;
        } else if (columnType === 'mrn') {
            modalTitle.textContent = 'Edit MRN Column Name';
            modalLabel.textContent = 'MRN Column Name:';
            currentValue = document.getElementById('mrn_column_display').textContent;
        } else if (columnType === 'date') {
            modalTitle.textContent = 'Edit Date Column Name';
            modalLabel.textContent = 'Date Column Name:';
            currentValue = document.getElementById('date_column_display').textContent;
        }
        
        modalInput.value = currentValue;
        modal.classList.remove('hidden');
        modalInput.focus();
        
        // Add keyboard support
        modalInput.onkeydown = function(e) {
            if (e.key === 'Enter') {
                saveColumnValue();
            } else if (e.key === 'Escape') {
                closeColumnModal();
            }
        };
    }

    function closeColumnModal() {
        document.getElementById('column-modal').classList.add('hidden');
    }

    function saveColumnValue() {
        const modalInput = document.getElementById('modal-input');
        const value = modalInput.value.trim();
        
        if (value) {
            setColumnValue(currentEditColumn, value);
        }
        
        closeColumnModal();
    }

    function setColumnValue(columnType, value) {
        if (columnType === 'accession') {
            document.getElementById('accession_column_display').textContent = value;
            document.getElementById('accession_column_value').value = value;
        } else if (columnType === 'mrn') {
            document.getElementById('mrn_column_display').textContent = value;
            document.getElementById('mrn_column_value').value = value;
        } else if (columnType === 'date') {
            document.getElementById('date_column_display').textContent = value;
            document.getElementById('date_column_value').value = value;
        }
    }

    function loadFiltersFromSettings(filters) {
        document.querySelector('#filters-container').innerHTML = '';
        if (filters.general_filters) {
            filters.general_filters.forEach(filter => {
                const newFilter = addFilter();
                newFilter.querySelector('[name="tag"]').value = filter.tag;
                newFilter.querySelector('[name="action"]').value = filter.action;
                newFilter.querySelector('[name="value"]').value = filter.value;
            });
        }
        if (filters.modality_filters) {
            Object.entries(filters.modality_filters).forEach(([modality, modalityFilters]) => {
                const filterContainer = document.querySelector(`#filter-container-${modality}`);
                if (filterContainer) {
                    filterContainer.innerHTML = '';
                    modalityFilters.forEach(filter => {
                        const template = document.querySelector('#filter-template');
                        const newFilter = template.cloneNode(true);
                        newFilter.style.display = 'block';
                        newFilter.removeAttribute('id');
                        newFilter.classList.add('filter-row');
                        
                        newFilter.querySelector('[name="tag"]').value = filter.tag;
                        newFilter.querySelector('[name="action"]').value = filter.action;
                        newFilter.querySelector('[name="value"]').value = filter.value;
                        
                        filterContainer.appendChild(newFilter);
                    });
                }
            });
        }
    }

    function toggleDeidOptions() {
        const deidOptions = document.getElementById('deid_options');
        const deidOptionsButton = document.getElementById('deidOptionsButton');
        deidOptions.classList.toggle('hidden');
        deidOptionsButton.textContent = deidOptions.classList.contains('hidden') ? '▼' : '▲';
    }

    function toggleScheduling() {
        const schedulingOptions = document.getElementById('scheduling_options');
        const deidButton = document.getElementById('deid_button');
        const isScheduled = document.getElementById('schedule_job').checked;
        
        schedulingOptions.classList.toggle('hidden', !isScheduled);
        updateButtonText();
    }

    function toggleLookupInput() {
        const lookupInputContainer = document.getElementById('lookup_input_container');
        const isChecked = document.getElementById('use_lookup').checked;
        lookupInputContainer.classList.toggle('hidden', !isChecked);
    }

    function updateButtonText() {
        const deidButton = document.getElementById('deid_button');
        const isScheduled = document.getElementById('schedule_job').checked;
        const isPacs = document.getElementById('image_source_pacs').checked;
        
        if (isScheduled) {
            deidButton.textContent = isPacs ? 'Schedule Pull Images and Deidentify' : 'Schedule Deidentify';
        } else {
            deidButton.textContent = isPacs ? 'Pull Images and Deidentify' : 'Deidentify';
        }
    }

    async function runDeid() {
        const filters = collectFilters('#filters-container');
        const isAccessionQuery = document.getElementById('query_accession').checked;
        const isScheduled = document.getElementById('schedule_job').checked;
        
        const data = {
            study_name: document.querySelector('[name="study_name"]').value,
            image_source: document.querySelector('input[name="image_source"]:checked').value,
            input_folder: document.querySelector('[name="input_folder"]').value,
            output_folder: document.querySelector('[name="output_folder"]').value,
            input_file: document.querySelector('[name="input_file"]').value,
            tags_to_keep: document.querySelector('[name="tags_to_keep"]').value,
            tags_to_dateshift: document.querySelector('[name="tags_to_dateshift"]').value,
            tags_to_randomize: document.querySelector('[name="tags_to_randomize"]').value,
            lookup_file: document.querySelector('[name="lookup_file"]').value || settings.lookup_file || '',
            use_lookup: document.getElementById('use_lookup').checked,
            deid_pixels: document.getElementById('deid_pixels').checked,
            remove_unspecified: document.getElementById('remove_unspecified').checked,
            remove_overlays: document.getElementById('remove_overlays').checked,
            remove_curves: document.getElementById('remove_curves').checked,
            remove_private: document.getElementById('remove_private').checked,
            date_shift_days: settings.date_shift_range || 0,
            site_id: settings.site_id || '',
            pacs_configs: settings.pacs_configs || [],
            application_aet: settings.application_aet || '',
            ...filters
        };

        if (data.image_source === 'PACS' && data.input_file) {
            if (!data.input_file.endsWith('.xlsx')) {
                alert('Input file must be an Excel file.');
                return;
            }
        }

        if (isScheduled) {
            const scheduledTime = document.getElementById('scheduled_time').value;
            if (!scheduledTime) {
                alert('Please select a scheduled time');
                return;
            }
            data.scheduled_time = scheduledTime;
        }

        if (isAccessionQuery) {
            data.acc_col = document.querySelector('[name="accession_column"]').value;
            data.mrn_col = document.querySelector('[name="mrn_column"]').value;
            data.date_col = '';
        } else {
            data.acc_col = '';
            data.mrn_col = document.querySelector('[name="mrn_column"]').value;
            data.date_col = document.querySelector('[name="date_column"]').value;
        }

        try {
            const response = await fetch('/run_deid/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            console.log(result)
            if (result.status === 'success') {
                if (isScheduled) {
                    window.location.href = '/task_list';
                } else {
                    window.location.href = `/task_progress?project_id=${result.project_id}`;
                }
            } else {
                console.error('Error starting de-identification:', result);
                alert(result.message || 'Error starting de-identification');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error starting de-identification: ' + error.message);
        }
    }

    function toggleModalityFilters() {
        const modalityOptions = document.getElementById('modality-options');
        modalityOptions.classList.toggle('hidden');
        
        if (!document.getElementById('modality-filter-toggle').checked) {
            document.getElementById('modality-filters-container').innerHTML = '';
        }
    }

    function handleModalitySelection(checkbox) {
        const modalityId = checkbox.value;
        const filterSection = document.getElementById(`filters-${modalityId}`);
        
        if (checkbox.checked) {
            filterSection.classList.remove('hidden');
            
            if (filterSection.children.length === 0) {
                const filterContainer = document.createElement('div');
                filterContainer.id = `filter-container-${modalityId}`;
                filterContainer.classList.add('space-y-2');
                
                const addButton = document.createElement('button');
                addButton.textContent = '+ Add Filter';
                addButton.classList.add('mt-2', 'px-2', 'py-1', 'bg-white', 'shadow', 'text-sm', 'hover:bg-blue-100');
                addButton.onclick = () => {
                    const template = document.querySelector('#filter-template');
                    const newFilter = template.cloneNode(true);
                    newFilter.style.display = 'block';
                    newFilter.removeAttribute('id');
                    filterContainer.appendChild(newFilter);
                };
                
                filterSection.appendChild(filterContainer);
                filterSection.appendChild(addButton);

                try {
                    fetch('/load_settings/')
                        .then(response => response.json())
                        .then(settings => {
                            const savedFilters = settings.deid_filters?.modality_filters?.[modalityId] || [];
                            if (savedFilters.length > 0) {
                                savedFilters.forEach(filter => {
                                    const template = document.querySelector('#filter-template');
                                    const newFilter = template.cloneNode(true);
                                    newFilter.style.display = 'block';
                                    newFilter.removeAttribute('id');
                                    filterContainer.appendChild(newFilter);
                                    newFilter.querySelector('[name="tag"]').value = filter.tag;
                                    newFilter.querySelector('[name="action"]').value = filter.action;
                                    newFilter.querySelector('[name="value"]').value = filter.value;
                                });
                            }
                        });
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
        } else {
            filterSection.classList.add('hidden');
        }
    }

    async function handleProtocolChange() {
        const protocolId = document.getElementById('protocol_select').value;
        if (!protocolId) return;

        try {
            const response = await fetch(`/get_protocol_settings/${protocolId}/`);
            if (!response.ok) throw new Error('Failed to load protocol settings');
            
            const data = await response.json();
            console.log('Received protocol settings:', data);  // Debug log
            
            if (data.protocol_settings) {
                // Update form fields
                document.querySelector('[name="tags_to_keep"]').value = data.protocol_settings.tags_to_keep || '';
                document.querySelector('[name="tags_to_dateshift"]').value = data.protocol_settings.tags_to_dateshift || '';
                document.querySelector('[name="tags_to_randomize"]').value = data.protocol_settings.tags_to_randomize || '';
                
                // Load filters
                if (data.protocol_settings.filters) {
                    loadFiltersFromSettings(data.protocol_settings.filters);
                }
                
                // Handle restricted status
                const isRestricted = data.protocol_settings.is_restricted;
                const restrictedLabel = document.getElementById('restricted-label');
                restrictedLabel.classList.toggle('hidden', !isRestricted);
                
                if (data.protocol_settings.is_restricted) {
                    const deidOptions = document.getElementById('deid_options');
                    if (deidOptions) {
                        const inputs = deidOptions.querySelectorAll('input, textarea, select, button');
                        inputs.forEach(input => input.disabled = true);
                    }
                }
            }
        } catch (error) {
            console.error('Error loading protocol settings:', error);
        }
    }

</script>
{% endblock %}
