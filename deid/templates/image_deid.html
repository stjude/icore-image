{% extends 'base.html' %}

{% block title %}Image De-identification{% endblock %}

{% block content %}
<div class="px-4">
    <h1 class="text-xl flex-1">Image De-identification</h1>
</div>
<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <div class="text-sm text-black-5">Project Name</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="study_name" />
    <div class="text-sm mt-6 text-black flex items-center space-x-4">
        Image Source: 
        <input class="ml-4" type="radio" id="image_source_local" name="image_source" value="LOCAL" checked onchange="toggleSourceOptions()"><span>Local folder</span>
        <input class="ml-4" type="radio" id="image_source_pacs" name="image_source" value="PACS" onchange="toggleSourceOptions()"> <span>PACS</span>
    </div>
    <div id="pacs_options" class="hidden mt-4">
        <div class="text-sm text-gray-500">Input File</div>
        <div class="flex items-center">
            <button class="h-6 shadow text-sm mr-2 mt-2 mb-2 border-2 border-gray-400" onclick="selectFile()">Browse</button>
            <div class="text-sm text-black ml-4" name="input_file">No file selected</div>
        </div>
        <div class="flex items-center mt-4">
            <div class="text-sm text-gray-600">Accession column header</div>
            <input type="text" class="w-40 ml-4 border-2 border-gray-400" name="column_header" />
        </div>
    </div>
    <div id="local_folder_options">
        <div class="text-sm text-gray-500 mt-4">Input Folder</div>
        <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_folder" />
        <div class="text-sm text-gray-500 mt-4">Output Folder</div>
        <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="output_folder" />
    </div>
    <div class="flex items-center mt-4">
        <button class="text-black" onclick="toggleDeidOptions()" id="deidOptionsButton">▼</button>
        <div class="text-sm text-black ml-4">De-identification Options</div>
    </div>
    <div id="deid_options" class="mt-4 hidden ml-4">
        <!-- General Filters Section -->
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">General Filters</div>
            {% include 'components/add_filters.html' %}
        </div>

        <!-- Modality Filters Section -->
        <div class="mt-4">
            <div class="flex items-center">
                <input type="checkbox" 
                       id="modality-filter-toggle" 
                       class="mr-2"
                       onchange="toggleModalityFilters()">
                <label for="modality-filter-toggle">Filter by Modality</label>
            </div>

            <!-- Modality options -->
            <div id="modality-options" class="ml-4 mt-2 hidden">
                <div class="grid grid-cols-1 gap-2">
                    {% for modality in modalities %}
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="modality-{{ modality }}" 
                                   value="{{ modality }}"
                                   class="modality-checkbox mr-2"
                                   onchange="handleModalitySelection(this)">
                            <label for="modality-{{ modality }}">{{ modality }}</label>
                        </div>
                        <div id="filters-{{ modality }}" class="ml-4 mt-2 hidden"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Container for modality-specific filters -->
            <div id="modality-filters-container" class="ml-4 mt-2">
            </div>
        </div>
    </div>
</div>
<div class="my-4">
    <button class="mt-4 px-2 py-1 bg-white shadow text-sm hover:bg-blue-100" onclick="runDeid()">Run De-id</button>
</div>


<script>
    function toggleSourceOptions() {
        const pacsOptions = document.getElementById('pacs_options');
        pacsOptions.classList.toggle('hidden');
    }

    function selectFile() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.style.display = 'none';
        fileInput.onchange = function() {
            if (this.files && this.files[0]) {
                const fileName = this.files[0].name;
                document.querySelector('[name="input_file"]').textContent = fileName;
            }
        };
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
    }

    function toggleDeidOptions() {
        const deidOptions = document.getElementById('deid_options');
        const deidOptionsButton = document.getElementById('deidOptionsButton');
        deidOptions.classList.toggle('hidden');
        deidOptionsButton.textContent = deidOptions.classList.contains('hidden') ? '▼' : '▲';
    }

    async function runDeid() {
        const data = {
            study_name: document.querySelector('[name="study_name"]').value,
            image_source: document.querySelector('input[name="image_source"]:checked').value,
            input_folder: document.querySelector('[name="input_folder"]').value,
            output_folder: document.querySelector('[name="output_folder"]').value,
            column_header: document.querySelector('[name="column_header"]').value,
            input_file: document.querySelector('[name="input_file"]').textContent,
            general_filters: [],
            modality_filters: {},
        };

        console.log("Starting filter collection...");

        // Get general filters - update the selector to match your template
        const generalFilterContainer = document.querySelector('#filters-container');  // or whatever class/id you're using
        console.log("General filter container:", generalFilterContainer);
        
        if (generalFilterContainer) {
            const filterRows = generalFilterContainer.querySelectorAll('.filter-row:not(#filter-template)');
            filterRows.forEach(filterRow => {
                const tagSelect = filterRow.querySelector('select[name="tag"]');  // Update if using different element
                const actionSelect = filterRow.querySelector('select[name="action"]');  // Update if using different element
                const valueInput = filterRow.querySelector('input[name="value"]');  // Update if using different element
                
                if (tagSelect && actionSelect) {
                    const filter = {
                        tag: tagSelect.value,
                        action: actionSelect.value,
                        value: valueInput ? valueInput.value : ''
                    };
                    if (filter.tag && filter.action) {
                        data.general_filters.push(filter);
                    }
                }
            });
        }

        // Get modality filters
        if (document.getElementById('modality-filter-toggle')?.checked) {
            const checkedModalities = document.querySelectorAll('.modality-checkbox:checked');
            
            checkedModalities.forEach(modalityCheckbox => {
                const modalityId = modalityCheckbox.value;
                const filterContainer = document.getElementById(`filter-container-${modalityId}`);
                console.log("Filter container:", filterContainer);
                
                if (filterContainer) {
                    const modalityFilters = [];
                    const filterRows = filterContainer.querySelectorAll('.filter-row:not(#filter-template)');
                    
                    filterRows.forEach(filterRow => {
                        const filter = {
                            tag: filterRow.querySelector('select[name="tag"]')?.value,
                            action: filterRow.querySelector('select[name="action"]')?.value,
                            value: filterRow.querySelector('input[name="value"]')?.value
                        };
                        console.log(`Collected modality filter for ${modalityId}:`, filter);
                        if (filter.tag && filter.action) {
                            modalityFilters.push(filter);
                        }
                    });
                    modalityFilters.push({tag: 'Modality', action: 'equals', value: modalityId})
                    
                    if (modalityFilters.length > 0) {
                        data.modality_filters[modalityId] = modalityFilters;
                    }
                }
            });
        }
        
        try {
            console.log("Sending request to /run_deid/");
            const response = await fetch('/run_deid/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            console.log("Request sent, awaiting response...");
            const result = await response.json();
            console.log('Success:', result);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function toggleModalityFilters() {
        const modalityOptions = document.getElementById('modality-options');
        modalityOptions.classList.toggle('hidden');
        
        if (!document.getElementById('modality-filter-toggle').checked) {
            document.getElementById('modality-filters-container').innerHTML = '';
        }
    }

    function handleModalitySelection(checkbox) {
        const modalityId = checkbox.value;
        const filterSection = document.getElementById(`filters-${modalityId}`);
        
        if (checkbox.checked) {
            filterSection.classList.remove('hidden');
            
            // Only initialize if empty
            if (filterSection.children.length === 0) {
                // Add filter container
                const filterContainer = document.createElement('div');
                filterContainer.id = `filter-container-${modalityId}`;
                filterContainer.classList.add('space-y-2');
                
                // Add "Add Filter" button
                const addButton = document.createElement('button');
                addButton.textContent = 'Add Filter';
                addButton.classList.add('mt-2');
                addButton.onclick = () => {
                    const template = document.querySelector('#filter-template');
                    const newFilter = template.cloneNode(true);
                    newFilter.style.display = 'block';
                    newFilter.removeAttribute('id');
                    filterContainer.appendChild(newFilter);
                };
                
                filterSection.appendChild(filterContainer);
                filterSection.appendChild(addButton);
            }
        } else {
            filterSection.classList.add('hidden');
        }
    }

</script>
{% endblock %}
