{% extends 'base.html' %}

{% block title %}Single-Click iCore{% endblock %}

{% block content %}
{% include 'modals/sas_url_required.html' %}
<div class="px-4">
    <h1 class="text-xl flex-1">Single-Click iCore</h1>
</div>

<!-- HIPAA Safe Harbor Banner -->
<div class="mx-4 mt-4 bg-blue-50 border-l-4 border-blue-500 p-4">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <div class="ml-3">
            <h3 class="text-md font-semibold text-blue-900">HIPAA Safe Harbor Mode (Automatic)</h3>
            <div class="mt-2 text-sm text-blue-800">
                <p class="font-medium">Single-click iCore automatically enforces HIPAA Safe Harbor de-identification per 45 CFR §164.514(b)(2).</p>
                <p class="mt-2">All 18 HIPAA identifiers will be removed or anonymized. Files containing encapsulated documents, PDFs, or burned-in annotations will be automatically quarantined for manual review.</p>
                <p class="mt-2"><strong>These settings are NOT user-configurable.</strong> For custom de-identification settings, use the Local De-identification workflow.</p>
            </div>
        </div>
    </div>
</div>

<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <div class="text-sm text-black-5">Project Name</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="study_name" onkeypress="return event.charCode !== 32"/>
    
    <div class="text-sm text-gray-500 mt-4">Input File</div>
    <div class="flex items-center">
        <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_file" placeholder="Drag and drop Excel file (from ptimorial/mPower)" />
    </div>
    
    <div class="text-sm text-gray-500 mt-4">Output Folder</div>
    <input type="text" class="mt-2 mb-2 w-full h-full border-2 border-gray-400 p-2" name="output_folder" placeholder="Folder to store deidentified images and Excel (preserved locally after export)" />
    
    <!-- Combined Deidentification Options -->
    <div class="flex items-center mt-4">
        <button class="text-black" onclick="toggleDeidOptions()" id="deidOptionsButton">▼</button>
        <div class="text-sm text-black ml-4">Deidentification Options</div>
    </div>
    <div id="deid_options" class="mt-4 hidden ml-4">
        <!-- Image Deidentification Sub-section -->
        <div class="mb-6">
            <div class="text-md font-medium mb-2">Image Deidentification</div>
            <div class="mb-4">
                <div class="text-sm text-gray-600 mb-2">General Filters</div>
                <div class="text-sm text-gray-400 mb-2">Only include images where</div>
                {% include 'components/add_filters.html' %}
            </div>

            <div class="mt-4">
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="modality-filter-toggle" 
                           class="mr-2"
                           onchange="toggleModalityFilters()">
                    <label for="modality-filter-toggle">Filter by Modality</label>
                </div>

                <div id="modality-options" class="ml-4 mt-2 hidden">
                    <div class="grid grid-cols-1 gap-2">
                        {% for modality in modalities %}
                        <div>
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       id="modality-{{ modality }}" 
                                       value="{{ modality }}"
                                       class="modality-checkbox mr-2"
                                       onchange="handleModalitySelection(this)">
                                <label for="modality-{{ modality }}">{{ modality }}</label>
                            </div>
                            <div id="filters-{{ modality }}" class="ml-4 mt-2 hidden"></div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="modality-filters-container" class="ml-4 mt-2">
                </div>
            
            </div>

            <div class="mt-6 bg-gray-50 border border-gray-300 rounded p-4">
                <div class="text-md mb-3 font-medium text-gray-900">Advanced Deidentification Options</div>
                <div class="text-sm text-gray-700 mb-4">
                    The following HIPAA Safe Harbor settings are automatically enforced and cannot be modified:
                </div>

                <div class="flex space-x-4 mb-4">
                    <div class="flex-1 bg-white p-3 rounded border border-gray-200">
                        <div class="text-sm font-medium text-gray-700 mb-2">To keep</div>
                        <div class="text-xs text-gray-600 space-y-1 max-h-32 overflow-y-auto">
                            {% for tag_name in tags_to_keep %}
                            <div>• {{ tag_name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="flex-1 bg-white p-3 rounded border border-gray-200">
                        <div class="text-sm font-medium text-gray-700 mb-2">To date shift</div>
                        <div class="text-xs text-gray-600 space-y-1 max-h-32 overflow-y-auto">
                            {% for tag_name in tags_to_dateshift %}
                            <div>• {{ tag_name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="flex-1 bg-white p-3 rounded border border-gray-200">
                        <div class="text-sm font-medium text-gray-700 mb-2">To randomize</div>
                        <div class="text-xs text-gray-600 space-y-1 max-h-32 overflow-y-auto">
                            {% for tag_name in tags_to_randomize %}
                            <div>• {{ tag_name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-gray-50 border border-gray-300 rounded p-4">
                <div class="text-md mb-3 font-medium text-gray-900">Global Deidentification Settings</div>
                <div class="text-sm text-gray-700 mb-4">
                    The following settings are automatically enabled for HIPAA Safe Harbor compliance:
                </div>

                <div class="space-y-2">
                    <div class="flex items-center text-sm">
                        <svg class="h-5 w-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-700"><strong>Remove unspecified tags</strong> - Any tag not specified in the lists above will be removed</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <svg class="h-5 w-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-700"><strong>Remove overlays</strong> - All elements in 60xx groups (may contain PHI)</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <svg class="h-5 w-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-700"><strong>Remove curve data</strong> - All elements in 50xx groups</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <svg class="h-5 w-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-700"><strong>Remove all private tags</strong> - Odd-numbered groups (not specified by DICOM standard)</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-gray-50 border border-gray-300 rounded p-4">
                <div class="text-md mb-3 font-medium text-gray-900">Pixel Deidentification</div>
                <div class="flex items-center text-sm">
                    <svg class="h-5 w-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-gray-700"><strong>Deidentify pixel data from device scanners</strong> - Blacks out regions of pixels in DICOM images from known devices</span>
                </div>
            </div>

            <div class="mt-8">
                <div class="text-md mb-4 mt-8">Mapping File Configuration</div>
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" id="use_mapping_file" name="use_mapping_file" class="mr-2" onchange="toggleMappingFileInput()">
                        <label for="use_mapping_file">Use Mapping File</label>
                    </div>
                    <div id="mapping_file_input_container" class="mt-2 hidden">
                        <input type="text" class="w-full h-full border-2 border-gray-400 p-2" name="mapping_file_path" />
                        <div class="text-sm text-gray-500 mt-1">Excel file with columns: TagName, New-TagName (e.g., AccessionNumber, New-AccessionNumber)</div>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <div class="text-md mb-4">Secondary Capture and PDF Handling</div>
                <div>
                    <div class="text-sm text-gray-500 mb-2">Secondary Capture images, PDFs, and other embedded content files contain unredactable PHI and will be filtered from de-identification output.</div>
                    <div class="ml-2">
                        <div class="flex items-center mb-2">
                            <input type="radio" id="sc_pdf_to_quarantine" name="sc_pdf_destination" value="quarantine" checked onchange="toggleScPdfCustomPath()">
                            <label for="sc_pdf_to_quarantine" class="ml-2">Send to quarantine folder</label>
                        </div>
                        <div class="flex items-center mb-2">
                            <input type="radio" id="sc_pdf_to_custom" name="sc_pdf_destination" value="custom" onchange="toggleScPdfCustomPath()">
                            <label for="sc_pdf_to_custom" class="ml-2">Send to custom location</label>
                        </div>
                        <div id="sc_pdf_custom_path_container" class="hidden mt-2 ml-6">
                            <input type="text" class="w-full border-2 border-gray-400 p-2" name="sc_pdf_output_dir" placeholder="Drag and drop folder or enter path" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Text Deidentification Sub-section -->
        <div class="mb-6">
            <div class="text-md font-medium mb-2">Text Deidentification</div>
            <div class="flex space-x-4 mt-4">
                <div class="flex-1">
                    <div class="text-sm text-gray-500">Columns to deid</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="columns_to_deid"></textarea>
                </div>
                <div class="flex-1">
                    <div class="text-sm text-gray-500">Columns to drop</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="columns_to_drop"></textarea>
                </div>
            </div>
            <div class="flex space-x-4 mt-4">
                <div class="flex-1">
                    <div class="text-sm text-gray-500">Phrases to keep</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="text_to_keep"></textarea>
                </div>
                <div class="flex-1">
                    <div class="text-sm text-gray-500">Phrases to remove</div>
                    <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="text_to_remove"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="m-4">
    <div class="flex items-center mb-4">
        <input type="checkbox" id="export_to_azure" class="mr-2" checked>
        <label for="export_to_azure">Export to Azure Blob Storage</label>
    </div>
    
    <div class="flex items-center mb-4">
        <input type="checkbox" id="schedule_job" class="mr-2" onchange="toggleScheduling()">
        <label for="schedule_job">Schedule Job</label>
    </div>
    
    <div id="scheduling_options" class="hidden mb-4">
        <input type="datetime-local" id="scheduled_time" class="border-2 border-gray-400 p-2">
    </div>

    <button class="mt-4 mb-4 px-2 py-1 bg-white shadow text-sm hover:bg-blue-100" onclick="runSingleClickICore()" id="singleclick_button" disabled>
        Pull Images, Deidentify, and Export
    </button>
</div>

<script>
    let settings = {};
    let adminSettings = {};
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/load_settings/');
            settings = await response.json();
            
            const adminResponse = await fetch('/load_admin_settings/');
            adminSettings = await adminResponse.json();
            
            if (settings.default_output_folder) {
                document.querySelector('[name="output_folder"]').value = settings.default_output_folder;
            }

            if (settings.mapping_file_path) {
                document.querySelector('[name="mapping_file_path"]').value = settings.mapping_file_path;
            }
            if (settings.use_mapping_file) {
                document.getElementById('use_mapping_file').checked = settings.use_mapping_file;
                toggleMappingFileInput();
            }

            if (settings.deid_filters) {
                loadFiltersFromSettings(settings.deid_filters);
            }

            // Text deid defaults
            if (settings.default_columns_to_deid) {
                document.querySelector('[name="columns_to_deid"]').value = settings.default_columns_to_deid;
            }
            if (settings.default_columns_to_drop) {
                document.querySelector('[name="columns_to_drop"]').value = settings.default_columns_to_drop;
            }
            if (settings.default_text_to_keep) {
                document.querySelector('[name="text_to_keep"]').value = settings.default_text_to_keep;
            }
            if (settings.default_text_to_remove) {
                document.querySelector('[name="text_to_remove"]').value = settings.default_text_to_remove;
            }

            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            fetch('/set_timezone/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ timezone: timezone })
            });

            document.querySelector('[name="study_name"]').addEventListener('input', validateForm);
            document.querySelector('[name="study_name"]').addEventListener('change', validateForm);
            document.querySelector('[name="input_file"]').addEventListener('input', validateForm);
            document.querySelector('[name="input_file"]').addEventListener('change', validateForm);
            validateForm();

        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });

    async function validateSasUrlOnLoad(sasUrl) {
        try {
            const response = await fetch('/validate_sas_url/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ sas_url: sasUrl })
            });
            
            const result = await response.json();
            
            return result;
        } catch (error) {
            console.error('Error validating SAS URL:', error);
            return { valid: false, error: 'Error validating SAS URL' };
        }
    }
    
    function getCsrfToken() {
        const tokenElement = document.querySelector('meta[name="csrf_token"]');
        return tokenElement ? tokenElement.content : '';
    }

    function validateForm() {
        const studyName = document.querySelector('[name="study_name"]').value.trim();
        const inputFile = document.querySelector('[name="input_file"]').value.trim();
        const button = document.getElementById('singleclick_button');
        
        const isValid = studyName && inputFile;
        
        if (isValid) {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function loadFiltersFromSettings(filters) {
        document.querySelector('#filters-container').innerHTML = '';
        if (filters.general_filters) {
            filters.general_filters.forEach(filter => {
                const newFilter = addFilter();
                newFilter.querySelector('[name="tag"]').value = filter.tag;
                newFilter.querySelector('[name="action"]').value = filter.action;
                newFilter.querySelector('[name="value"]').value = filter.value;
            });
        }
        if (filters.modality_filters) {
            Object.entries(filters.modality_filters).forEach(([modality, modalityFilters]) => {
                const filterContainer = document.querySelector(`#filter-container-${modality}`);
                if (filterContainer) {
                    filterContainer.innerHTML = '';
                    modalityFilters.forEach(filter => {
                        const template = document.querySelector('#filter-template');
                        const newFilter = template.cloneNode(true);
                        newFilter.style.display = 'block';
                        newFilter.removeAttribute('id');
                        newFilter.classList.add('filter-row');
                        
                        newFilter.querySelector('[name="tag"]').value = filter.tag;
                        newFilter.querySelector('[name="action"]').value = filter.action;
                        newFilter.querySelector('[name="value"]').value = filter.value;
                        
                        filterContainer.appendChild(newFilter);
                    });
                }
            });
        }
    }

    function toggleDeidOptions() {
        const deidOptions = document.getElementById('deid_options');
        const deidOptionsButton = document.getElementById('deidOptionsButton');
        deidOptions.classList.toggle('hidden');
        deidOptionsButton.textContent = deidOptions.classList.contains('hidden') ? '▼' : '▲';
    }

    function toggleScheduling() {
        const schedulingOptions = document.getElementById('scheduling_options');
        const isScheduled = document.getElementById('schedule_job').checked;
        schedulingOptions.classList.toggle('hidden', !isScheduled);
        updateButtonText();
    }

    function toggleMappingFileInput() {
        const mappingFileInputContainer = document.getElementById('mapping_file_input_container');
        const isChecked = document.getElementById('use_mapping_file').checked;
        mappingFileInputContainer.classList.toggle('hidden', !isChecked);
    }

    function toggleScPdfCustomPath() {
        const container = document.getElementById('sc_pdf_custom_path_container');
        const isCustom = document.getElementById('sc_pdf_to_custom').checked;
        container.classList.toggle('hidden', !isCustom);
    }

    function updateButtonText() {
        const button = document.getElementById('singleclick_button');
        const isScheduled = document.getElementById('schedule_job').checked;
        button.textContent = isScheduled ? 'Schedule Pull, Deidentify, and Export' : 'Pull Images, Deidentify, and Export';
    }

    async function runSingleClickICore() {
        const exportEnabled = document.getElementById('export_to_azure').checked;
        
        if (exportEnabled) {
            if (!adminSettings.imagine_sas_url || adminSettings.imagine_sas_url.trim() === '') {
                document.getElementById('sasUrlRequiredModal').classList.remove('hidden');
                return;
            }
            const sasValidation = await validateSasUrlOnLoad(adminSettings.imagine_sas_url);
            if (!sasValidation.valid) {
                document.getElementById('sasUrlRequiredModal').classList.remove('hidden');
                return;
            }
        }

        const filters = collectFilters('#filters-container');
        const isScheduled = document.getElementById('schedule_job').checked;
        
        const scPdfCustom = document.getElementById('sc_pdf_to_custom').checked;
        const scPdfPath = document.querySelector('[name="sc_pdf_output_dir"]').value;

        const data = {
            study_name: document.querySelector('[name="study_name"]').value,
            input_file: document.querySelector('[name="input_file"]').value,
            output_folder: document.querySelector('[name="output_folder"]').value,
            // Image deid options
            mapping_file_path: document.querySelector('[name="mapping_file_path"]').value || settings.mapping_file_path || '',
            use_mapping_file: document.getElementById('use_mapping_file').checked,

            pacs_configs: settings.pacs_configs || [],
            application_aet: settings.application_aet || '',
            sas_url: adminSettings.imagine_sas_url || '',
            sc_pdf_output_dir: (scPdfCustom && scPdfPath) ? scPdfPath : '',
            // Text deid options
            text_to_keep: document.querySelector('[name="text_to_keep"]').value,
            text_to_remove: document.querySelector('[name="text_to_remove"]').value,
            columns_to_deid: document.querySelector('[name="columns_to_deid"]').value,
            columns_to_drop: document.querySelector('[name="columns_to_drop"]').value,
            // Export preference
            export_to_azure: document.getElementById('export_to_azure').checked,
            ...filters
        };

        if (!data.input_file.endsWith('.xlsx')) {
            alert('Input file must be an Excel file.');
            return;
        }

        if (isScheduled) {
            const scheduledTime = document.getElementById('scheduled_time').value;
            if (!scheduledTime) {
                alert('Please select a scheduled time');
                return;
            }
            data.scheduled_time = scheduledTime;
        }

        try {
            const response = await fetch('/run_singleclickicore/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.status === 'success') {
                if (isScheduled) {
                    window.location.href = '/task_list';
                } else {
                    window.location.href = `/task_progress?project_id=${result.project_id}`;
                }
            } else {
                alert(result.message || 'Error starting Single-Click iCore');
                console.error('Error:', result);
            }
        } catch (error) {
            alert('Error starting Single-Click iCore: ' + error.message);
            console.error('Error:', error);
        }
    }

    function toggleModalityFilters() {
        const modalityOptions = document.getElementById('modality-options');
        modalityOptions.classList.toggle('hidden');
        
        if (!document.getElementById('modality-filter-toggle').checked) {
            document.getElementById('modality-filters-container').innerHTML = '';
        }
    }

    function handleModalitySelection(checkbox) {
        const modalityId = checkbox.value;
        const filterSection = document.getElementById(`filters-${modalityId}`);
        
        if (checkbox.checked) {
            filterSection.classList.remove('hidden');
            
            if (filterSection.children.length === 0) {
                const filterContainer = document.createElement('div');
                filterContainer.id = `filter-container-${modalityId}`;
                filterContainer.classList.add('space-y-2');
                
                const addButton = document.createElement('button');
                addButton.textContent = '+ Add Filter';
                addButton.classList.add('mt-2', 'px-2', 'py-1', 'bg-white', 'shadow', 'text-sm', 'hover:bg-blue-100');
                addButton.onclick = () => {
                    const template = document.querySelector('#filter-template');
                    const newFilter = template.cloneNode(true);
                    newFilter.style.display = 'block';
                    newFilter.removeAttribute('id');
                    filterContainer.appendChild(newFilter);
                };
                
                filterSection.appendChild(filterContainer);
                filterSection.appendChild(addButton);

                try {
                    fetch('/load_settings/')
                        .then(response => response.json())
                        .then(settings => {
                            const savedFilters = settings.deid_filters?.modality_filters?.[modalityId] || [];
                            if (savedFilters.length > 0) {
                                savedFilters.forEach(filter => {
                                    const template = document.querySelector('#filter-template');
                                    const newFilter = template.cloneNode(true);
                                    newFilter.style.display = 'block';
                                    newFilter.removeAttribute('id');
                                    filterContainer.appendChild(newFilter);
                                    newFilter.querySelector('[name="tag"]').value = filter.tag;
                                    newFilter.querySelector('[name="action"]').value = filter.action;
                                    newFilter.querySelector('[name="value"]').value = filter.value;
                                });
                            }
                        });
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
        } else {
            filterSection.classList.add('hidden');
        }
    }
</script>
{% endblock %}

