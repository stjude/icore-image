{% extends 'base.html' %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="px-4">
    <h1 class="text-xl flex-1">Profile</h1>
</div>
<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <div class="text-md mb-4">iCore Use Case</div>
    <div class="text-sm text-gray-500 mb-4">
        Select how you are using iCore. This determines which modules are available.
    </div>
    
    <div class="mt-4">
        <div class="mb-3">
            <label class="inline-flex items-center">
                <input type="radio" name="usecase" value="internal" class="form-radio" id="usecase-internal">
                <span class="ml-2">Local/Internal use only</span>
            </label>
            <div class="ml-6 mt-1 text-sm text-gray-500">
                Access to all iCore modules for local deidentification projects
            </div>
        </div>
        <div class="mb-3">
            <label class="inline-flex items-center">
                <input type="radio" name="usecase" value="imagine" class="form-radio" id="usecase-imagine">
                <span class="ml-2">IMAGINE Initiative project</span>
            </label>
            <div class="ml-6 mt-1 text-sm text-gray-500">
                Access limited to Single-Click iCore and Secure Data Transfer modules for IMAGINE project compliance
            </div>
        </div>
    </div>
    
    <div class="mt-6">
        <button id="saveUsecaseBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
            Save
        </button>
    </div>
    
    <div id="successMessage" class="hidden mt-4 p-3 bg-green-100 text-green-700 rounded">
        Profile updated successfully!
    </div>
</div>

<script>
    let currentUsecase = '';
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/load_settings/');
            const settings = await response.json();
            currentUsecase = settings.icore_usecase || '';
            
            if (currentUsecase === 'internal') {
                document.getElementById('usecase-internal').checked = true;
            } else if (currentUsecase === 'imagine') {
                document.getElementById('usecase-imagine').checked = true;
            }
        } catch (error) {
            console.error('Error loading profile:', error);
        }
        
        document.getElementById('saveUsecaseBtn').addEventListener('click', async () => {
            const selectedUsecase = document.querySelector('input[name="usecase"]:checked');
            
            if (!selectedUsecase) {
                alert('Please select a use case');
                return;
            }
            
            try {
                const response = await fetch('/load_settings/');
                const settings = await response.json();
                
                settings.icore_usecase = selectedUsecase.value;
                
                await fetch('/save_settings/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf_token"]').content
                    },
                    body: JSON.stringify(settings)
                });
                
                applyModuleFiltering(selectedUsecase.value);
                
                const successMessage = document.getElementById('successMessage');
                successMessage.classList.remove('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000);
                
                currentUsecase = selectedUsecase.value;
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
            }
        });
    });
    
    function applyModuleFiltering(usecase) {
        if (usecase === 'imagine') {
            const allModules = document.querySelectorAll('.sidebar-module');
            allModules.forEach(module => {
                module.style.display = 'none';
            });
        } else {
            const allModules = document.querySelectorAll('.sidebar-module, .sidebar-module-imagine');
            allModules.forEach(module => {
                module.style.display = 'block';
            });
        }
    }
</script>
{% endblock %}

