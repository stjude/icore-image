{% extends 'base.html' %}

{% block title %}Text De-identification{% endblock %}

{% block content %}
<div class="px-4">
    <h1 class="text-xl flex-1">Text De-identification</h1>
</div>
<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <!-- Project Name Section -->
    <div class="text-sm text-black-5">Project Name</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="study_name" />

    <!-- Input File Section -->
    <div class="text-sm text-black-5 mt-4">Input Folder</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_folder" />

    <!-- Output File Section -->
    <div class="text-sm text-black-5 mt-4">Output Folder</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="output_folder" />

    <!-- De-identification Options Section -->
    <div class="flex items-center mt-4">
        <button class="text-black" onclick="toggleDeidOptions()" id="deidOptionsButton">▼</button>
        <div class="text-sm text-black ml-4">De-identification Options</div>
    </div>
    <div id="deid_options" class="mt-4 hidden ml-4">
        <div class="flex space-x-4">
            <div class="flex-1">
                <div class="text-sm text-gray-500">To keep</div>
                <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="text_to_keep"></textarea>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-500">To remove</div>
                <textarea class="w-full border-2 border-gray-400 pt-1 px-2 pb-2 h-32 overflow-y-auto resize-none" name="text_to_remove"></textarea>
            </div>
        </div>

        <!-- Date Shift Section -->
        <div class="mt-4">
            <div class="text-sm text-gray-500">Date Shift (days)</div>
            <input type="number" 
                   class="mt-2 w-40 border-2 border-gray-400 p-2" 
                   name="date_shift_days" 
                   value="0" />
            <div class="text-xs text-gray-400 mt-1">Enter number of days to shift dates forward (positive) or backward (negative)</div>
        </div>
    </div>
</div>

<!-- Run Button Section -->
<div class="m-4">
    <button class="mt-4 px-2 py-1 bg-white shadow text-sm hover:bg-blue-100" onclick="runDeid()">Run De-id</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadSavedSettings);

    async function loadSavedSettings() {
        try {
            const response = await fetch('/load_settings/');
            const settings = await response.json();
            
            // Apply default settings
            if (settings.default_output_folder) {
                document.querySelector('[name="output_folder"]').value = settings.default_output_folder;
            }
            if (settings.default_text_to_keep) {
                document.querySelector('[name="text_to_keep"]').value = settings.default_text_to_keep;
            }
            if (settings.default_text_to_remove) {
                document.querySelector('[name="text_to_remove"]').value = settings.default_text_to_remove;
            }
            if (settings.default_date_shift_days) {
                document.querySelector('[name="date_shift_days"]').value = settings.default_date_shift_days;
            }
            if (settings.selected_protocol) {
                // If you want to show the selected protocol somewhere
                console.log('Selected protocol:', settings.selected_protocol);
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    async function runDeid() {
        const data = {
            study_name: document.querySelector('[name="study_name"]').value,
            input_folder: document.querySelector('[name="input_folder"]').value,
            output_folder: document.querySelector('[name="output_folder"]').value,
            text_to_keep: document.querySelector('[name="text_to_keep"]').value,
            text_to_remove: document.querySelector('[name="text_to_remove"]').value,
            date_shift_days: document.querySelector('[name="date_shift_days"]').value
        };

        try {
            const response = await fetch('/run_text_deid/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.status === 'success') {
                window.location.href = `/task_progress?output_folder=${encodeURIComponent(data.output_folder)}`;
            } else {
                console.error('Error starting de-identification:', result);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function toggleDeidOptions() {
        const deidOptions = document.getElementById('deid_options');
        const deidOptionsButton = document.getElementById('deidOptionsButton');
        deidOptions.classList.toggle('hidden');
        deidOptionsButton.textContent = deidOptions.classList.contains('hidden') ? '▼' : '▲';
    }
</script>
{% endblock %}
