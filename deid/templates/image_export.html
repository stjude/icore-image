{% extends 'base.html' %}

{% block title %}Secure Data Transfer{% endblock %}

{% block content %}
{% include 'modals/sas_url_required.html' %}
<div class="px-4">
    <h1 class="text-xl flex-1">Secure Data Transfer</h1>
</div>

<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <div class="text-sm text-black-5">Project Name</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="study_name" onkeypress="return event.charCode !== 32" />

    <div class="text-sm text-black-5 mt-4">Select Folder for Secure Data Transfer</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_folder" placeholder="Drag and drop folder to export" />
    
    <div class="text-sm text-black-5 mt-4">SAS URL (configured in Admin Settings)</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2 bg-gray-100" name="sas_url" placeholder="https://account.blob.core.windows.net/container?sas_token" readonly />
</div>

<div class="m-4">
    <button class="mt-4 px-2 py-1 bg-white shadow text-sm hover:bg-blue-100" onclick="runExport()" id="export_button" disabled>
        Run Export
    </button>
</div>

<script>
    let settings = {};
    let adminSettings = {};
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/load_settings/');
            settings = await response.json();
            
            const adminResponse = await fetch('/load_admin_settings/');
            adminSettings = await adminResponse.json();

            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            fetch('/set_timezone/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ timezone: timezone })
            });

            if (!adminSettings.imagine_sas_url || adminSettings.imagine_sas_url.trim() === '') {
                document.getElementById('sasUrlRequiredModal').classList.remove('hidden');
                document.getElementById('export_button').disabled = true;
                return;
            } else {
                const result = await validateSasUrlOnLoad(adminSettings.imagine_sas_url);
                if (!result.valid) {
                    document.getElementById('sasUrlRequiredModal').classList.remove('hidden');
                    document.getElementById('export_button').disabled = true;
                    return;
                }
            }
            
            document.querySelector('[name="study_name"]').addEventListener('input', validateExportForm);
            document.querySelector('[name="study_name"]').addEventListener('change', validateExportForm);
            document.querySelector('[name="input_folder"]').addEventListener('input', validateExportForm);
            document.querySelector('[name="input_folder"]').addEventListener('change', validateExportForm);
            
            validateExportForm();
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });
    
    async function validateSasUrlOnLoad(sasUrl) {
        try {
            const response = await fetch('/validate_sas_url/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ sas_url: sasUrl })
            });
            
            const result = await response.json();
            
            return result;
        } catch (error) {
            console.error('Error validating SAS URL:', error);
            return { valid: false, error: 'Error validating SAS URL' };
        }
    }
    
    function getCsrfToken() {
        const tokenElement = document.querySelector('meta[name="csrf_token"]');
        return tokenElement ? tokenElement.content : '';
    }

    function validateExportForm() {
        const studyName = document.querySelector('[name="study_name"]').value.trim();
        const inputFolder = document.querySelector('[name="input_folder"]').value.trim();
        const sasUrl = document.querySelector('[name="sas_url"]').value.trim();
        const button = document.getElementById('export_button');
        
        const isValid = studyName && inputFolder && sasUrl;
        
        if (isValid) {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    async function runExport() {
        const studyName = document.querySelector('[name="study_name"]').value.trim();
        const inputFolder = document.querySelector('[name="input_folder"]').value.trim();
        const sasUrl = document.querySelector('[name="sas_url"]').value.trim();

        const data = {
            study_name: studyName,
            input_folder: inputFolder,
            sas_url: sasUrl
        };

        const button = document.getElementById('export_button');
        button.disabled = true;
        button.textContent = 'Starting Export...';

        try {
            const response = await fetch('/run_export/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.status === 'success') {
                window.location.href = `/task_progress?project_id=${result.project_id}`;
            } else {
                button.disabled = false;
                button.textContent = 'Run Export';
                alert(result.message || 'Error starting export. Please try again.');
                console.error('Error starting export:', result);
            }
        } catch (error) {
            button.disabled = false;
            button.textContent = 'Run Export';
            alert('Error starting export: ' + error.message);
            console.error('Error:', error);
        }
    }
</script>
{% endblock %} 