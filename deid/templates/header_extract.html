{% extends 'base.html' %}

{% block title %}DICOM Header Extraction{% endblock %}

{% block content %}
{{ storage_locations|json_script:"storage-locations-data" }}
<script>
    const storageLocations = JSON.parse(document.getElementById('storage-locations-data').textContent);
</script>

<div class="px-4">
    <h1 class="text-xl flex-1">DICOM Header Extraction</h1>
</div>

<div class="flex-1 bg-white p-4 ml-4 mt-4">
    <div class="text-sm text-black-5">Project Name</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="study_name" />

    <div class="text-sm text-black-5 mt-4">Input Folder</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="input_folder" />

    <div class="text-sm text-black-5 mt-4">Output Folder</div>
    <input type="text" class="mt-2 w-full h-full border-2 border-gray-400 p-2" name="output_folder" />

    <div class="flex items-center mt-4">
        <button class="text-black" onclick="toggleHeaderExtractOptions()" id="headerExtractOptionsButton">▼</button>
        <div class="text-sm text-black ml-4">Header Extraction Options</div>
    </div>
    <div id="header_extract_options" class="mt-4 hidden ml-4">
        <div class="flex items-center mt-2">
            <input type="checkbox" id="extract_all_headers" name="extract_all_headers" class="mr-2" />
            <label for="extract_all_headers" class="text-sm text-gray-700">Extract All Headers</label>
        </div>
        <div class="text-xs text-gray-500 mt-2 ml-6">
            If checked, extracts all DICOM headers found in the images. Otherwise, extracts only the default headers.
        </div>
    </div>
</div>

<div class="m-4">
    <button class="mt-4 mb-4 px-2 py-1 bg-white shadow text-sm hover:bg-blue-100" onclick="runHeaderExtract()" id="header_extract_button">
        Run Extraction
    </button>
</div>

<script>
    let settings = {};
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/load_settings/');
            settings = await response.json();

            if (settings.default_output_folder) {
                document.querySelector('[name="output_folder"]').value = settings.default_output_folder;
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });

    function toggleHeaderExtractOptions() {
        const headerExtractOptions = document.getElementById('header_extract_options');
        const headerExtractOptionsButton = document.getElementById('headerExtractOptionsButton');
        headerExtractOptions.classList.toggle('hidden');
        headerExtractOptionsButton.textContent = headerExtractOptions.classList.contains('hidden') ? '▼' : '▲';
    }

    async function runHeaderExtract() {
        const studyName = document.querySelector('[name="study_name"]').value.trim();
        const inputFolder = document.querySelector('[name="input_folder"]').value.trim();
        const outputFolder = document.querySelector('[name="output_folder"]').value.trim();
        const extractAllHeaders = document.getElementById('extract_all_headers').checked;

        if (!studyName) {
            alert('Project name is required');
            return;
        }
        if (!inputFolder) {
            alert('Input folder is required');
            return;
        }
        if (!outputFolder) {
            alert('Output folder is required');
            return;
        }

        const data = {
            study_name: studyName,
            input_folder: inputFolder,
            output_folder: outputFolder,
            extract_all_headers: extractAllHeaders
        };
        console.log(data);

        try {
            const response = await fetch('/run_header_extract/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.status === 'success') {
                window.location.href = `/task_progress?project_id=${result.project_id}`;
            } else {
                console.error('Error starting header extract:', result);
                alert(result.message || 'Error starting header extraction');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error starting header extraction: ' + error.message);
        }
    }
</script>
{% endblock %} 