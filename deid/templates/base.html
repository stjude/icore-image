{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <title>iCore</title>
        <meta name="csrf_token" content="{{ csrf_token }}">
        <!-- <link rel="icon" href="{% static 'favicon.ico' %}"> -->
        <!-- <link href="{% static 'tailwind.min.css' %}" rel="stylesheet"> -->
        <!-- <script src="{% static 'alpine.min.js' %}"></script> -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="{% static 'js/filters.js' %}"></script>
    </head>
    <body class="bg-gray-100">
        <header class="fixed w-full z-20 p-4 flex bg-white text-white shadow">
            <div class="flex-1 text-lg my-auto">
                <a href="/imagequery" class="flex items-center space-x-2">
                    <img id="app-logo" src="{% static 'logo.png' %}" width="50px" height="50px" alt="iCore Logo" class="object-contain">
                    <span class="text-gray-700 font-semibold">iCore</span>
                </a>
            </div>
            <div class="flex-initial my-auto text-sm text-gray-700">
                <a href="/task_list" class="rounded mx-2 px-2 py-1 hover:bg-gray-100 {% if request.path == '/task_list/' %}bg-gray-100{% endif %}">Projects</a>
                <a href="/settings/general" class="rounded mx-2 px-2 py-1 hover:bg-gray-100 {% if request.path == '/settings/general/' %}bg-gray-100{% endif %}">Settings</a>
            </div>
        </header>
        <section class="fixed z-10 w-64 h-screen bg-white shadow text-sm text-gray-700 pt-24">
            <a href="/imagequery" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/imagequery/' %}bg-gray-100{% endif %}">Image Query</a>
            <a href="/imagedeid" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/imagedeid/' %}bg-gray-100{% endif %}">Image Deidentification</a>
            <a href="/imagedeidexport" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/imagedeidexport/' %}bg-gray-100{% endif %}">Image Deidentification and Export</a>
            <a href="/textdeid" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/textdeid/' %}bg-gray-100{% endif %}">Text Deidentification</a>
            <a href="/imageexport" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/imageexport/' %}bg-gray-100{% endif %}">Secure Data Transfer</a>
            <a href="/headerextract" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/headerextract/' %}bg-gray-100{% endif %}">Header Extraction</a>
        <!-- {% for module in modules %}
            <a href="/{{ module.name }}" class="block px-4 py-2 hover:bg-gray-100 {% if request.path == '/{{ module.name }}/' %}bg-gray-100{% endif %}">{{ module.name }}</a>
        {% endfor %} -->
        </section>
        <section class="w-full h-screen pt-24 pl-64">
            <div class="max-w-4xl mx-auto mb-10">
                {% block content %}{% endblock %}
            </div>
        </section>
        
        {% include 'modals/usecase_setup.html' %}
        {% include 'modals/sas_url_input.html' %}
        
        <script>
            async function checkAndShowUsecaseSetup() {
                try {
                    const response = await fetch('/load_settings/');
                    const settings = await response.json();
                    
                    if (!settings.icore_usecase) {
                        document.getElementById('usecaseModal').classList.remove('hidden');
                    } else if (settings.icore_usecase === 'imagine' && !settings.imagine_sas_url) {
                        document.getElementById('sasUrlModal').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error checking usecase setup:', error);
                }
            }
            
            async function saveUsecase(usecase) {
                try {
                    const response = await fetch('/load_settings/');
                    const settings = await response.json();
                    
                    settings.icore_usecase = usecase;
                    
                    await fetch('/save_settings/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf_token"]').content
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Error saving usecase:', error);
                    return false;
                }
            }
            
            async function validateAndSaveSasUrl(sasUrl) {
                const validationMessage = document.getElementById('sasUrlValidationMessage');
                const validateBtn = document.getElementById('sasUrlValidateBtn');
                
                validateBtn.disabled = true;
                validateBtn.textContent = 'Validating...';
                validationMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
                validationMessage.classList.add('bg-blue-100', 'text-blue-700');
                validationMessage.textContent = 'Validating SAS URL...';
                
                try {
                    const validationResponse = await fetch('/validate_sas_url/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf_token"]').content
                        },
                        body: JSON.stringify({ sas_url: sasUrl })
                    });
                    
                    const validationResult = await validationResponse.json();
                    
                    if (validationResult.valid) {
                        const response = await fetch('/load_settings/');
                        const settings = await response.json();
                        
                        settings.imagine_sas_url = sasUrl;
                        
                        await fetch('/save_settings/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('meta[name="csrf_token"]').content
                            },
                            body: JSON.stringify(settings)
                        });
                        
                        validationMessage.classList.remove('bg-blue-100', 'text-blue-700');
                        validationMessage.classList.add('bg-green-100', 'text-green-700');
                        validationMessage.textContent = 'SAS URL validated and saved successfully!';
                        
                        setTimeout(() => {
                            document.getElementById('sasUrlModal').classList.add('hidden');
                        }, 1500);
                        
                        return true;
                    } else {
                        validationMessage.classList.remove('bg-blue-100', 'text-blue-700');
                        validationMessage.classList.add('bg-red-100', 'text-red-700');
                        validationMessage.textContent = `Validation failed: ${validationResult.error}`;
                        return false;
                    }
                } catch (error) {
                    validationMessage.classList.remove('bg-blue-100', 'text-blue-700');
                    validationMessage.classList.add('bg-red-100', 'text-red-700');
                    validationMessage.textContent = `Error: ${error.message}`;
                    return false;
                } finally {
                    validateBtn.disabled = false;
                    validateBtn.textContent = 'Validate & Save';
                }
            }
            
            document.addEventListener('DOMContentLoaded', () => {
                checkAndShowUsecaseSetup();
                
                const usecaseSubmitBtn = document.getElementById('usecaseSubmitBtn');
                if (usecaseSubmitBtn) {
                    usecaseSubmitBtn.addEventListener('click', async () => {
                        const selectedUsecase = document.querySelector('input[name="usecase"]:checked').value;
                        const success = await saveUsecase(selectedUsecase);
                        
                        if (success) {
                            document.getElementById('usecaseModal').classList.add('hidden');
                            
                            if (selectedUsecase === 'imagine') {
                                document.getElementById('sasUrlModal').classList.remove('hidden');
                            }
                        }
                    });
                }
                
                const sasUrlValidateBtn = document.getElementById('sasUrlValidateBtn');
                if (sasUrlValidateBtn) {
                    sasUrlValidateBtn.addEventListener('click', async () => {
                        const sasUrl = document.getElementById('sasUrlInput').value.trim();
                        if (sasUrl) {
                            await validateAndSaveSasUrl(sasUrl);
                        } else {
                            const validationMessage = document.getElementById('sasUrlValidationMessage');
                            validationMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                            validationMessage.classList.add('bg-red-100', 'text-red-700');
                            validationMessage.textContent = 'Please enter a SAS URL';
                        }
                    });
                }
                
                const sasUrlCancelBtn = document.getElementById('sasUrlCancelBtn');
                if (sasUrlCancelBtn) {
                    sasUrlCancelBtn.addEventListener('click', () => {
                        document.getElementById('sasUrlModal').classList.add('hidden');
                    });
                }
                
                const sasUrlBackBtn = document.getElementById('sasUrlBackBtn');
                if (sasUrlBackBtn) {
                    sasUrlBackBtn.addEventListener('click', () => {
                        document.getElementById('sasUrlModal').classList.add('hidden');
                        document.getElementById('usecaseModal').classList.remove('hidden');
                    });
                }
                
                const inputBoxes = document.querySelectorAll('input[type="text"]');

                // Loop through each input box and attach event listeners
                inputBoxes.forEach((inputBox) => {
                    inputBox.addEventListener('dragover', (event) => {
                        event.preventDefault(); // Allow drop by preventing default behavior
                    });

                    inputBox.addEventListener('drop', async (event) => {
                        event.preventDefault();

                        const file = event.dataTransfer.files[0];
                        if (file) {
                            const fullPath = await window.electronAPI.getPathForFile(file);
                            inputBox.value = fullPath; // Set the full path in the dropped input box
                            
                            // Trigger validation after setting value
                            inputBox.dispatchEvent(new Event('input', { bubbles: true }));
                            inputBox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });
            });
        </script>
    </body>
</html>
