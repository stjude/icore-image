{% extends 'base.html' %}

{% block title %}Progress{% endblock %}

{% block content %}
<div class="px-4">
    <h1 class="text-xl flex-1">Progress</h1>
    <div id="errorPopup" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Error</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="errorMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeError" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-4 bg-black text-white p-4 font-mono text-sm h-[calc(100vh-10rem)] overflow-y-auto" id="logContent">
    </div>
</div>

<script>
    const outputFolder = new URLSearchParams(window.location.search).get('output_folder');
    let previousContent = '';
    let sameContentCount = 0;
    let pollInterval;
    let hasError = false;
    
    // List of error messages from validate_config
    const errorMessages = [
        "Config file unable to load or invalid.",
        "Module not specified in config file.",
        "Module invalid or not implemented.",
        "Input directory not found.",
        "Output directory must be empty.",
        "Pacs details missing in config file.",
        "Either the accession column name or mrn + date column names are required.",
        "Can only query using one of accession or mrn + date. Not both.",
        "Date window must be an integer.",
        "No DICOM files found in input directory.",
        "Input directory must contain input.xlsx file.",
        "Invalid CTP filters.",
        "Invalid CTP anonymizer.",
        "Invalid excel file."
    ];
    
    async function fetchLogContent() {
        if (hasError) return;
        
        try {
            const response = await fetch(`/get_log_content?output_folder=${encodeURIComponent(outputFolder)}`);
            const data = await response.text();
            const logContent = document.getElementById('logContent');
            for (const errorMsg of errorMessages) {
                if (data.includes(errorMsg)) {
                    hasError = true;
                    document.getElementById('errorMessage').textContent = errorMsg;
                    document.getElementById('errorPopup').classList.remove('hidden');
                    break;
                }
                if (data.includes("No output folder specified")) {
                    hasError = true;
                    document.getElementById('errorMessage').textContent = "No output folder specified";
                    document.getElementById('errorPopup').classList.remove('hidden');
                    break;
                }
            }
            
            if (data === previousContent) {
                sameContentCount++;
                if (sameContentCount >= 200) {
                    clearInterval(pollInterval);
                    return;
                }
            } else {
                sameContentCount = 0;
                previousContent = data;
            }

            
            logContent.innerHTML = data.replace(/\n/g, '<br>');
            logContent.scrollTop = logContent.scrollHeight;
        } catch (error) {
            console.error('Error fetching log:', error);
        }
    }

    // Handle closing the error popup
    document.getElementById('closeError').addEventListener('click', function() {
        document.getElementById('errorPopup').classList.add('hidden');
        window.history.back(); // Return to previous page
    });

    // Initial fetch
    fetchLogContent();

    // Poll every second
    pollInterval = setInterval(fetchLogContent, 1000);
</script>
{% endblock %}
